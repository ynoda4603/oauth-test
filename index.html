<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Salesforce OAuth Token Flow (Client Credentials)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .warning { color: red; font-weight: bold; border: 1px solid red; padding: 10px; margin-bottom: 15px; }
    button { padding: 10px 15px; font-size: 16px; cursor: pointer; }
    pre { background-color: #F0F0F0; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; word-break: break-all; }
  </style>
</head>
<body>
  <h1>Salesforce Client Credentials Flow ログイン</h1>
  <div class="warning">
    <strong>セキュリティに関する非常に重要な注意:</strong><br>
    このサンプルでは、クライアントシークレット (`clientSecret`) をフロントエンドのJavaScriptコードに直接記述しています。これは、ブラウザの開発者ツールなどで誰でも閲覧可能になるため、**非常に危険であり、本番環境では絶対に避けるべきです。**<br>
    Client Credentials Grant フローは通常、サーバーサイドアプリケーションなど、クライアントシークレットを安全に保管できる環境で使用されます。<br>
    もしフロントエンドからSalesforce APIを利用する必要がある場合は、Backend for Frontend (BFF) パターンを検討するか、Salesforceが推奨する他のより安全なOAuthフロー（ユーザー認証を伴う場合はPKCE付き認可コードフローなど）の利用を検討してください。
  </div>
  <button id="loginBtn">アクセストークン取得 (Client Credentials)</button>
  <div id="resultArea" style="margin-top: 20px;">
    <h3>結果:</h3>
    <pre id="resultText">ここに結果が表示されます...</pre>
  </div>
  <script>
    const clientId = '3MVG929eOx29turHjzNb74yZQnXr5uJtUsDrzM__YQJ3v.Ta9KLfsqAtjHafYKqzMaK5pAIRywXy7dvix2KuZ'; // あなたのクライアントID
    const clientSecret = '3D066D0E344B0E3286C048CAAEBA0EC23F64651D3CE8D5209DFEBE8478F3C0C4'; // あなたのクライアントシークレット (★セキュリティリスク★)
    // redirectUri は Client Credentials Grant では通常不要です。
    // const redirectUri = 'https://ynoda4603.github.io/oauth-test/callback.html';
    const tokenEndpointUrl = 'https://trainingco2-dev-ed.develop.my.salesforce.com/services/oauth2/token'; // あなたのSalesforce組織のトークンエンドポイント
    // generateRandomString 関数は Client Credentials Grant では通常不要です。
    /*
    function generateRandomString(length = 16) {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      const array = new Uint32Array(length);
      crypto.getRandomValues(array);
      for (let i = 0; i < length; i++) {
        result += charset[array[i] % charset.length];
      }
      return result;
    }
    */
    document.getElementById('loginBtn').addEventListener('click', async () => { // async 関数に変更
      const resultTextElement = document.getElementById('resultText');
      resultTextElement.textContent = 'トークン取得処理中...';
      // Client Credentials Grant では state や redirect_uri は通常不要です。
      // const state = generateRandomString();
      // localStorage.setItem('oauth_state', state);
      const params = new URLSearchParams();
      params.append('grant_type', 'client_credentials');
      params.append('client_id', clientId);
      params.append('client_secret', clientSecret);
      // params.append('scope', 'api'); // 必要に応じてスコープを指定 (例: 'api full')
      try {
        const response = await fetch(tokenEndpointUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: params.toString(), // URLSearchParamsオブジェクトを文字列化してボディに設定
        });
        const responseData = await response.json(); // レスポンスは通常JSON形式
        if (response.ok) {
          console.log('トークン取得成功:', responseData);
          resultTextElement.textContent = 'トークン取得成功:\n' + JSON.stringify(responseData, null, 2);
          // ここで取得したアクセストークン (例: responseData.access_token) を使用する処理
          // 例: localStorage.setItem('salesforce_access_token', responseData.access_token);
        } else {
          console.error('トークン取得失敗:', response.status, response.statusText, responseData);
          resultTextElement.textContent = `トークン取得失敗 (ステータス: ${response.status}):\n` + JSON.stringify(responseData, null, 2);
        }
      } catch (error) {
        console.error('通信エラーまたは予期せぬエラー:', error);
        resultTextElement.textContent = '通信エラーまたは予期せぬエラーが発生しました:\n' + error.toString();
      }
    });
  </script>
</body>
</html>
