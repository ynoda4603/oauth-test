<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OAuth Callback</title>
</head>
<body>
  <h1>アクセストークン取得＆Account作成</h1>
  <pre id="output">読み込み中...</pre>

  <script>
    function parseHashParams(hash) {
      const params = {};
      const queryString = hash.substring(1);
      const regex = /([^&=]+)=([^&]*)/g;
      let m;
      while ((m = regex.exec(queryString))) {
        params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
      }
      return params;
    }

    async function createAccount(accessToken, instanceUrl) {
      const account = {
        Name: 'GitHub OAuth テスト',
        Phone: '03-1234-5678',
        Website: 'https://example.com'
      };

      const response = await fetch(${instanceUrl}/services/data/v59.0/sobjects/Account, {
        method: 'POST',
        headers: {
          'Authorization': Bearer ${accessToken},
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(account)
      });

      const result = await response.json();
      return result;
    }

    (async () => {
      const hashParams = parseHashParams(window.location.hash);
      const accessToken = hashParams.access_token;
      const instanceUrl = hashParams.instance_url;

      const output = document.getElementById('output');

      if (!accessToken || !instanceUrl) {
        output.textContent = 'アクセストークンまたはインスタンスURLが取得できませんでした。';
        return;
      }

      try {
        const result = await createAccount(accessToken, instanceUrl);
        if (result.id) {
          output.textContent = 取引先レコード作成成功！ID: ${result.id};
        } else {
          output.textContent = 作成失敗: ${JSON.stringify(result, null, 2)};
        }
      } catch (e) {
        output.textContent = エラー: ${e};
      }
    })();
  </script>
</body>
</html>
