<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Salesforce Callback</title>
</head>
<body>
  <h1>Salesforce OAuth & å–å¼•å…ˆä½œæˆ</h1>
  <pre id="result">å‡¦ç†ä¸­...</pre>

  <script>
    const resultEl = document.getElementById('result');

    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã‚’URLã®ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
    const hashParams = new URLSearchParams(window.location.hash.slice(1));
    const accessToken = hashParams.get('access_token');
    const instanceUrl = hashParams.get('instance_url');
    const returnedState = hashParams.get('state');
    const savedState = localStorage.getItem('oauth_state');

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!accessToken || !instanceUrl || !returnedState) {
      resultEl.innerText = 'âŒ ã‚¨ãƒ©ãƒ¼ï¼šãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚';
    } else if (returnedState !== savedState) {
      resultEl.innerText = 'âŒ ã‚¨ãƒ©ãƒ¼ï¼šstate ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚';
    } else {
      resultEl.innerText = 'âœ… ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸã€‚\nSalesforce ã«å–å¼•å…ˆãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆä¸­...';

    // ç¾åœ¨æ™‚åˆ»ã®å–å¾—ï¼ˆä¾‹: "2025-05-22 14:37:12"ï¼‰
    const now = new Date();
    const formattedTime = `${now.getFullYear()}-${(now.getMonth() + 1)
      .toString()
      .padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now
      .getHours()
      .toString()
      .padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now
      .getSeconds()
      .toString()
      .padStart(2, '0')}`;

      // REST APIã§å–å¼•å…ˆãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
      fetch(`${instanceUrl}/services/data/v63.0/sobjects/Account/`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          Name: `GitHubã‹ã‚‰ã®å–å¼•å…ˆ - ${formattedTime}`,
          Phone: '03-1234-5678'
        })
      })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(data => {
          resultEl.innerText = 'ğŸ‰ å–å¼•å…ˆãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæˆåŠŸï¼\n\n' + JSON.stringify(data, null, 2);
        })
        .catch(err => {
          resultEl.innerText = `âŒ ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆå¤±æ•—ï¼š${err.message}`;
        });
    }

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    localStorage.removeItem('oauth_state');
    history.replaceState({}, document.title, location.pathname);
  </script>
</body>
</html>
