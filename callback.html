<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Salesforce OAuth Callback</title>
</head>
<body>
  <h1>OAuth認証リダイレクト</h1>
  <p id="status">アクセストークンを取得中...</p>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const returnedState = params.get('state');
    const expectedState = sessionStorage.getItem('oauth_state');

    if (!code || returnedState !== expectedState) {
      document.getElementById('status').textContent = 'エラー：不正な認可コードまたは state';
      throw new Error('Invalid code or state');
    }

    const tokenEndpoint = 'https://login.salesforce.com/services/oauth2/token';
    const clientId = '3MVG929eOx29turHjzNb74yZQnXr5uJtUsDrzM__YQJ3v.Ta9KLfsqAtjHafYKqzMaK5pAIRywXy7dvix2KuZ'; // 置き換えてください
    const redirectUri = 'https://ynoda4603.github.io/oauth-test/callback.html';
    const codeVerifier = sessionStorage.getItem('pkce_code_verifier');

    async function exchangeCodeForToken() {
      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: clientId,
        code: code,
        redirect_uri: redirectUri,
        code_verifier: codeVerifier
      });

      try {
        const response = await fetch(tokenEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: body
        });

        if (!response.ok) {
          throw new Error(`Token request failed: ${response.status}`);
        }

        const data = await response.json();
        console.log('Access Token:', data.access_token);
        document.getElementById('status').textContent = 'アクセストークン取得成功！取引先を作成中...';

        // ✅ ここで Salesforce API を呼び出して取引先を作成できます（CORS問題があればプロキシが必要）

      } catch (err) {
        console.error(err);
        document.getElementById('status').textContent = 'アクセストークンの取得に失敗しました。';
      }
    }

    exchangeCodeForToken();
  </script>
</body>
</html>
