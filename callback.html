<!DOCTYPE html>
<html>
<head>
  <title>OAuth Callback</title>
</head>
<body>
  <h2>アクセストークンを取得中...</h2>
  <div id="result"></div>

  <script>
    const clientId = '3MVG929eOx29turHjzNb74yZQnXr5uJtUsDrzM__YQJ3v.Ta9KLfsqAtjHafYKqzMaK5pAIRywXy7dvix2KuZ';
    const redirectUri = 'https://ynoda4603.github.io/oauth-test/callback.html';
    const loginUrl = 'https://login.salesforce.com';

    async function exchangeCodeForToken(code) {
      const tokenUrl = `${loginUrl}/services/oauth2/token`;
      const codeVerifier = localStorage.getItem('code_verifier');

      const params = new URLSearchParams();
      params.append('grant_type', 'authorization_code');
      params.append('code', code);
      params.append('client_id', clientId);
      params.append('redirect_uri', redirectUri);
      params.append('code_verifier', codeVerifier);

      const res = await fetch(tokenUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      });

      return res.json();
    }

    async function callApi(accessToken, instanceUrl) {
      const res = await fetch(`${instanceUrl}/services/apexrest/CreateAccountAPI/`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      });
      const text = await res.text();
      document.getElementById('result').textContent = 'API Response: ' + text;
    }

    (async () => {
      const code = new URLSearchParams(window.location.search).get('code');
      if (!code) {
        document.getElementById('result').textContent = '認可コードが見つかりません';
        return;
      }

      const tokenResponse = await exchangeCodeForToken(code);
      if (tokenResponse.access_token && tokenResponse.instance_url) {
        await callApi(tokenResponse.access_token, tokenResponse.instance_url);
      } else {
        document.getElementById('result').textContent = 'アクセストークン取得失敗: ' + JSON.stringify(tokenResponse);
      }
    })();
  </script>
</body>
</html>
